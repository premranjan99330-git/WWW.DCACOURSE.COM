<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Verify & Download</title>
  <style>
    /* Full-bleed blank page */
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#ffffff 0%, #ffffff 100%)}
    /* Centering container */
    .wrap{height:100%;display:flex;align-items:center;justify-content:center}

    /* 3D looking button */
    .btn {
      --btn-w: 320px;
      --btn-h: 88px;
      width:var(--btn-w);
      height:var(--btn-h);
      border-radius:18px;
      border:none;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      font-size:20px;
      font-weight:700;
      letter-spacing:0.4px;
      color:#0f172a;
      background: linear-gradient(180deg, #f7fbff 0%, #e6f0ff 50%, #dce9ff 100%);
      box-shadow: 0 18px 30px rgba(5,30,95,0.12), 0 6px 12px rgba(5,30,95,0.06), inset 0 -4px 8px rgba(255,255,255,0.6);
      transition: transform 160ms cubic-bezier(.2,.9,.3,1), box-shadow 160ms;
      -webkit-tap-highlight-color: transparent;
      position:relative;
    }
    .btn:active{transform:translateY(6px);box-shadow: 0 10px 18px rgba(5,30,95,0.08), 0 3px 8px rgba(5,30,95,0.04)}

    /* subtle shine */
    .btn::after{
      content:'';
      position:absolute;
      left:12%;right:12%;top:6%;height:36%;border-radius:12px;
      background:linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.15));
      pointer-events:none;mix-blend-mode:overlay;
    }

    /* tiny description under button (hidden by default) */
    .hint{margin-top:18px;color:#8391a5;font-size:13px;text-align:center}

    /* loading spinner */
    .spinner{width:22px;height:22px;border-radius:50%;border:3px solid rgba(15,23,42,0.08);border-top-color:#0f172a;animation:spin 1s linear infinite;margin-left:12px}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* toast */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:38px;background:#0f172a;color:white;padding:10px 16px;border-radius:10px;box-shadow:0 8px 24px rgba(15,23,42,0.12);font-size:14px;display:none}
    .toast.show{display:block}

    /* make page look exactly minimal when printed */
    @media print{body{background:white}}
  </style>
</head>
<body>
  <div class="wrap">
    <div style="text-align:center">
      <button id="downloadBtn" class="btn" aria-label="Verify and download certificate">
        <span id="btnText">Verify & Download</span>
      </button>
      <div class="hint" id="hintText" aria-hidden="true">Tap the button to verify and start the download.</div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    (function(){
      const btn = document.getElementById('downloadBtn');
      const btnText = document.getElementById('btnText');
      const toast = document.getElementById('toast');
      const hint = document.getElementById('hintText');

      function showToast(msg, ms=3000){
        toast.textContent = msg; toast.classList.add('show');
        setTimeout(()=> toast.classList.remove('show'), ms);
      }

      function getCertId(){
        try{
          const params = new URLSearchParams(location.search);
          const id = params.get('id');
          if(id) return id.replace(/[^a-zA-Z0-9_-]/g,'');
        }catch(e){}
        return null;
      }

      function getDownloadUrl(id){
        // By default we expect certificates hosted under /certificates/<id>.pdf
        // If no id, fallback to 'certificate.pdf' in same folder.
        if(id) return `${location.origin}${location.pathname.replace(/\/$/, '')}/certificates/${id}.pdf`;
        // fallback: same directory file
        return `${location.origin}${location.pathname.replace(/\/$/, '')}/certificate.pdf`;
      }

      async function startDownload(){
        const id = getCertId();
        const url = getDownloadUrl(id);

        // Show tiny spinner in button
        const spinner = document.createElement('span'); spinner.className = 'spinner';
        btnText.textContent = 'Starting...'; btn.appendChild(spinner);
        btn.disabled = true;

        // Try HEAD first to see if file exists (works for same-origin)
        try{
          const resp = await fetch(url, { method: 'HEAD', cache: 'no-store' });
          if(resp.ok){
            // Trigger navigation â€” browser will either download or open the file depending on type
            location.href = url;
          } else if(resp.status === 404){
            showToast('Certificate not found');
          } else {
            showToast('Unable to fetch certificate (status: '+resp.status+')');
          }
        }catch(err){
          // If HEAD fails (CORS or network), still try to navigate
          console.error(err);
          showToast('Network error; attempting download...');
          location.href = url;
        } finally{
          // restore button state after a short delay so user sees activity
          setTimeout(()=>{ btn.disabled=false; btnText.textContent='Verify & Download'; if(spinner.parentNode===btn) btn.removeChild(spinner); }, 1200);
        }
      }

      // Click handler
      btn.addEventListener('click', startDownload);

      // Accessibility: Space/Enter
      btn.addEventListener('keydown', function(e){ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); startDownload(); } });

      // If someone lands without id, show hint with subtle opacity change
      if(!getCertId()){
        hint.style.opacity = '0.6';
      } else {
        hint.style.opacity = '0';
      }

    })();
  </script>
</body>
</html>
